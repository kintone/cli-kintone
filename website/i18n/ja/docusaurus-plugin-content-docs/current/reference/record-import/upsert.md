# UPSERT：レコードの更新または挿入

## 概念

| 用語       | 説明                                                                                                                                                                                                                  |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 更新キー   | インポートされたレコードとkintone上のレコードを紐付けるフィールドコード。以下のフィールドがサポートされています：<br/>- レコード番号フィールド<br/>- 「値の重複を禁止する」設定がある以下のフィールド<br/> - 文字列（1行）<br/> - 数値フィールド |
| Upsert     | 更新キーに一致するレコードが存在する場合はレコードを更新します。存在しない場合は、新しいレコードを追加します。                                                                                                      |

## コマンドラインインターフェース

```shell
// 更新キーを指定
cli-kintone record import --app 8 --file-path records.csv --update-key companyName
```

| パラメーター名 | 短縮名 | 説明     |
| -------------- | ------ | -------- |
| `--update-key` |        | 更新キー |

## レコードのUpsert

ユーザーは`--update-key`オプションで更新キーを指定できます。

- ツールは一致するレコードを検索し、以下を実行します：
  - 一致するレコードが存在する場合、レコードを更新します
  - 一致するレコードが存在しない場合、新しいレコードを追加します
- 更新と追加は、CSVの順序で実行されます。
- レコード番号フィールドは、「キーとなる項目」として指定されている場合にのみ、更新されるレコードに対して評価されます。
- 更新されるレコードの以下のフィールドは無視されます。
  - 作成者
  - 作成日時
  - 更新者
  - 更新日時

更新キーが以下の条件を満たす場合、エラーが発生します

- キーがCSVファイルに存在しない。
- フィールドが「値の重複を禁止する」として設定されていない

## レコード番号フィールドの指定

- レコード番号列には、Task-1のようなアプリコードを含めることができます。すべての行に同じアプリコードが含まれている必要があります。
- アプリコードはkintoneアプリのものと等しい必要があります。

## エラー

- 更新キーで指定されたフィールドがkintoneアプリに存在しない。
- 更新キーで指定されたフィールドがサポートされていない。文字列（1行）フィールドまたは数値フィールドでもない。
- 更新キーで指定されたフィールドはサポートされているが、「値の重複を禁止する」設定がない。
- 更新キーがレコード番号フィールドの場合、レコード番号が混在し、アプリコードを含むものと含まないものがある。
- 更新キーがレコード番号フィールドの場合、レコード番号にkintoneアプリのもの以外のアプリコードが含まれている。
- 更新キーで指定されたフィールドがソースファイルに存在しない。
